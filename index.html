<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Racer Fixed</title>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', sans-serif; }
        #wrapper { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; background: #000; }
        canvas { display: block; box-shadow: 0 0 50px rgba(0, 255, 255, 0.2); }
        
        /* –°—Ç–∏–ª–∏ –º–µ–Ω—é */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; background: rgba(0,0,0,0.85); color: #00f3ff;
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 3.5rem; text-transform: uppercase; text-shadow: 0 0 20px #00f3ff; margin-bottom: 30px; letter-spacing: 5px; }
        button {
            padding: 18px 45px; font-size: 1.3rem; background: transparent; 
            border: 2px solid #ff00ff; color: #ff00ff; cursor: pointer; margin: 10px;
            text-transform: uppercase; font-weight: bold; transition: 0.3s;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
        }
        button:hover { background: #ff00ff; color: white; box-shadow: 0 0 30px #ff00ff; }
        
        #hud {
            position: absolute; top: 20px; width: 90%; display: flex; 
            justify-content: space-between; pointer-events: none; z-index: 5;
            color: #00f3ff; font-family: monospace; font-size: 1.5rem;
            text-shadow: 2px 2px 5px #000;
        }

        .shop-container { display: flex; gap: 15px; margin-bottom: 30px; }
        .car-item { 
            border: 2px solid #444; padding: 15px; text-align: center; 
            background: #111; cursor: pointer; width: 120px;
        }
        .car-item.selected { border-color: #39ff14; box-shadow: 0 0 15px #39ff14; }
    </style>
</head>
<body>

<div id="wrapper">
    <div id="hud" class="hidden">
        <div>SCORE: <span id="scoreVal">0</span></div>
        <div>COINS: <span id="coinsVal">0</span></div>
    </div>

    <div id="mainMenu" class="overlay">
        <h1>Speed Racer</h1>
        <button id="startBtn">START RACE</button>
        <button id="garageBtn">GARAGE</button>
    </div>

    <div id="shopMenu" class="overlay hidden">
        <h1>Garage</h1>
        <div class="shop-container" id="shopItems"></div>
        <button id="backBtn">BACK</button>
    </div>

    <div id="gameOver" class="overlay hidden">
        <h1 style="color:#ff00ff">WRECKED!</h1>
        <p id="finalScore" style="font-size: 1.5rem; color: #fff;"></p>
        <button id="retryBtn">TRY AGAIN</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
/**
 * –í–µ—Å—å –∫–æ–¥ –∑–∞–≤–µ—Ä–Ω—É—Ç –≤ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, 
 * —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏—Å—å –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã.
 */
(function() {
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let state = 'MENU';
    let score = 0;
    let coins = parseInt(localStorage.getItem('racer_coins')) || 0;
    let speed = 5;
    let roadOffset = 0;
    let enemies = [];
    let pickups = [];
    let keys = {};
    
    // –î–∞–Ω–Ω—ã–µ –º–∞—à–∏–Ω
    const cars = [
        { name: "Neon", color: "#00f3ff", speedMod: 1, price: 0, owned: true },
        { name: "Shadow", color: "#9d00ff", speedMod: 1.4, price: 500, owned: false },
        { name: "Beast", color: "#ff0055", speedMod: 1.8, price: 1500, owned: false }
    ];
    let activeCarIdx = parseInt(localStorage.getItem('racer_car_idx')) || 0;
    const ownedData = JSON.parse(localStorage.getItem('racer_owned')) || [true, false, false];
    ownedData.forEach((owned, i) => cars[i].owned = owned);

    const player = { x: 0, y: 0, w: 45, h: 80, vx: 0 };

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);
    
    function resize() {
        canvas.width = Math.min(window.innerWidth, 500);
        canvas.height = window.innerHeight;
        player.x = canvas.width / 2 - player.w / 2;
        player.y = canvas.height - 130;
    }
    window.addEventListener('resize', resize);
    resize();

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞—à–∏–Ω—ã (–±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è roundRect –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    function drawCar(x, y, color, isPlayer = false) {
        ctx.save();
        // –¢–µ–Ω—å
        ctx.fillStyle = 'rgba(0,0,0,0.4)';
        ctx.fillRect(x + 4, y + 4, player.w, player.h);
        
        // –ö–æ—Ä–ø—É—Å
        ctx.fillStyle = color;
        ctx.fillRect(x, y, player.w, player.h);
        
        // –°—Ç–µ–∫–ª–æ
        ctx.fillStyle = 'rgba(0,0,0,0.6)';
        ctx.fillRect(x + 5, y + 15, player.w - 10, 20);
        
        // –§–∞—Ä—ã
        ctx.fillStyle = isPlayer ? '#fff' : '#ffff00';
        ctx.fillRect(x + 5, y, 10, 5); 
        ctx.fillRect(x + player.w - 15, y, 10, 5);
        
        // –°–ø–æ–π–ª–µ—Ä (–µ—Å–ª–∏ –∏–≥—Ä–æ–∫)
        if(isPlayer) {
            ctx.fillStyle = color;
            ctx.fillRect(x - 2, y + player.h - 10, player.w + 4, 5);
        }
        ctx.restore();
    }

    function update() {
        if (state !== 'PLAYING') return;

        speed += 0.002;
        score += speed / 5;
        roadOffset = (roadOffset + speed) % 100;

        // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        const accel = 0.8;
        if (keys['ArrowLeft'] || keys['KeyA']) player.vx -= accel;
        if (keys['ArrowRight'] || keys['KeyD']) player.vx += accel;
        
        player.vx *= 0.85; // –¢—Ä–µ–Ω–∏–µ
        player.x += player.vx;

        // –ì—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–∞—Å—Å—ã
        if (player.x < 55) { player.x = 55; player.vx = 0; }
        if (player.x > canvas.width - 55 - player.w) { player.x = canvas.width - 55 - player.w; player.vx = 0; }

        // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤
        if (Math.random() < 0.02) {
            enemies.push({ 
                x: 60 + Math.random() * (canvas.width - 160), 
                y: -100, 
                col: hsl(${Math.random()*360}, 70%, 50%),
                s: 2 + Math.random() * 3
            });
        }

        // –°–ø–∞–≤–Ω –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        if (Math.random() < 0.01) {
            pickups.push({ 
                x: 70 + Math.random() * (canvas.width - 140), 
                y: -50, 
                type: Math.random() > 0.3 ? 'COIN' : 'OIL' 
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–∞–≥–æ–≤
        enemies.forEach((en, i) => {
            en.y += speed * 0.7 + en.s;
            if (en.y > canvas.height) enemies.splice(i, 1);
            
            // –ö–æ–ª–ª–∏–∑–∏—è
            if (player.x < en.x + 40 && player.x + 40 > en.x && player.y < en.y + 70 && player.y + 70 > en.y) {
                endGame();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        pickups.forEach((p, i) => {
            p.y += speed;
            if (p.y > canvas.height) pickups.splice(i, 1);
            if (Math.abs(player.x - p.x) < 40 && Math.abs(player.y - p.y) < 40) {
                if (p.type === 'COIN') { coins += 10; score += 100; }
                else { speed *= 0.7; } // –ú–∞—Å–ª–æ –∑–∞–º–µ–¥–ª—è–µ—Ç
                pickups.splice(i, 1);
            }
        });

        document.getElementById('scoreVal').innerText = Math.floor(score);
        document.getElementById('coinsVal').innerText = coins;
    }

    function draw() {
        // –§–æ–Ω
        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –î–æ—Ä–æ–≥–∞
        ctx.fillStyle = '#222';
        ctx.fillRect(50, 0, canvas.width - 100, canvas.height);

        // –†–∞–∑–º–µ—Ç–∫–∞
        ctx.strokeStyle = '#fff';
        ctx.setLineDash([30, 30]);
        ctx.lineDashOffset = -roadOffset;
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, 0);
        ctx.lineTo(canvas.width / 2, canvas.height);
        ctx.stroke();

        // –ù–µ–æ–Ω–æ–≤—ã–µ –æ–±–æ—á–∏–Ω—ã
        ctx.setLineDash([]);
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#00f3ff';
        ctx.fillStyle = '#00f3ff';
        ctx.fillRect(45, 0, 5, canvas.height);
        ctx.fillRect(canvas.width - 50, 0, 5, canvas.height);
        ctx.shadowBlur = 0;

        // –ü—Ä–µ–¥–º–µ—Ç—ã
        pickups.forEach(p => {
            ctx.fillStyle = p.type === 'COIN' ? '#ffd700' : '#555';
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.type === 'COIN' ? 10 : 15, 0, Math.PI*2);
            ctx.fill();
        });

        // –í—Ä–∞–≥–∏ –∏ –∏–≥—Ä–æ–∫
        enemies.forEach(en => drawCar(en.x, en.y, en.col));
        drawCar(player.x, player.y, cars[activeCarIdx].color, true);
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é
    function startGame() {
        state = 'PLAYING';
        score = 0;
        speed = 5 * cars[activeCarIdx].speedMod;
        enemies = [];
        pickups = [];
        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('gameOver').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
    }

    function endGame() {
        state = 'GAMEOVER';
        document.getElementById('gameOver').classList.remove('hidden');
        document.getElementById('finalScore').innerText = "Total Score: " + Math.floor(score);
        localStorage.setItem('racer_coins', coins);
    }

    function renderShop() {
        const container = document.getElementById('shopItems');
        container.innerHTML = '';
        cars.forEach((car, i) => {
            const div = document.createElement('div');
            div.className = car-item ${activeCarIdx === i ? 'selected' : ''};
            div.style.color = car.color;
            div.innerHTML = 
                <strong>${car.name}</strong><br>
                ${car.owned ? 'READY' : car.price + ' ü™ô'}
            ;
            div.onclick = () => {
                if (car.owned) {
                    activeCarIdx = i;
                    localStorage.setItem('racer_car_idx', i);
                } else if (coins >= car.price) {
                    coins -= car.price;
                    car.owned = true;
                    activeCarIdx = i;
                    localStorage.setItem('racer_owned', JSON.stringify(cars.map(c => c.owned)));
                    localStorage.setItem('racer_coins', coins);
                }
                renderShop();
            };
            container.appendChild(div);
        });
    }

    // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫ (–≤–º–µ—Å—Ç–æ onclick –≤ HTML)
    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('retryBtn').onclick = startGame;
    document.getElementById('garageBtn').onclick = () => {
        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('shopMenu').classList.remove('hidden');
        renderShop();
    };
    document.getElementById('backBtn').onclick = () => {
        document.getElementById('shopMenu').classList.add('hidden');
        document.getElementById('mainMenu').classList.remove('hidden');
    };

    // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
    loop();
})();
</script>
</body>
</html>
